{% extends "yoga/base.html" %}
{% load static %}

{% block title %}Yoga Session{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-4">
  <div class="max-w-7xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      
      <!-- Main Webcam Panel -->
      <div class="lg:col-span-3">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
          <div class="aspect-video bg-gray-900 relative">
            <video id="webcam" autoplay muted playsinline class="w-full h-full object-cover" controls></video>
            <canvas id="canvas" class="hidden"></canvas>
            
            <div id="overlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50">
              <div class="text-center text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 12h18M3 17h18" />
                </svg>
                <p class="text-lg">Click Start Session to begin</p>
              </div>
            </div>
            
            <div id="liveBadge" class="absolute top-4 left-4 bg-red-500 text-white px-3 py-1 rounded-full text-sm font-medium animate-pulse hidden">
              LIVE
            </div>

            <!-- Pose accuracy indicator -->
            <div id="accuracyIndicator" class="absolute top-4 right-4 hidden">
              <div class="bg-white bg-opacity-90 rounded-lg px-4 py-2 shadow-lg">
                <div class="flex items-center space-x-2">
                  <div id="statusIcon" class="w-3 h-3 rounded-full bg-gray-400"></div>
                  <span id="statusText" class="text-sm font-medium text-gray-700">Detecting...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Controls -->
          <div class="p-4 bg-white border-t flex items-center justify-center space-x-4">
            <button id="toggleSession" class="flex items-center px-6 py-3 rounded-lg font-medium bg-green-500 text-white hover:bg-green-600 transition-all duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Start Session
            </button>

            <button id="switchCamera" class="flex items-center px-4 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Switch Camera
            </button>

            <label for="videoUpload" id="uploadBtn" class="flex items-center px-4 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors cursor-pointer">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              Upload Video
            </label>
            <input type="file" id="videoUpload" accept="video/*" class="hidden">

            <button id="removeVideoBtn" class="hidden items-center px-4 py-3 border border-red-300 rounded-lg text-red-700 hover:bg-red-50 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              Remove Video
            </button>
          </div>
        </div>

        <!-- Session Stats -->
        <div class="mt-6 grid grid-cols-3 gap-4">
          <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-500 mb-1">Frames Analyzed</div>
            <div id="totalFrames" class="text-2xl font-bold text-gray-900">0</div>
          </div>
          <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-500 mb-1">Correct Poses</div>
            <div id="correctFrames" class="text-2xl font-bold text-green-600">0</div>
          </div>
          <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-500 mb-1">Session Accuracy</div>
            <div id="sessionAccuracy" class="text-2xl font-bold text-blue-600">0%</div>
          </div>
        </div>
      </div>

      <!-- Side Panel -->
      <div class="space-y-6">
        <!-- Session Timer -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Session Time</h3>
          </div>
          <div id="sessionTimer" class="text-3xl font-bold text-center text-green-600">00:00</div>
        </div>

        <!-- Current Pose -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Current Pose</h3>
          <div class="text-center">
            <div id="currentPose" class="text-2xl font-bold text-gray-900 mb-2">â€”</div>
            <div class="text-sm text-gray-500 mb-4">Confidence: <span id="confidence">0</span>%</div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="confidenceBar" class="h-2 rounded-full bg-red-500 transition-all duration-500" style="width:0%"></div>
            </div>
          </div>
        </div>

        <!-- Feedback -->
        <div id="feedbackCard" class="rounded-lg shadow-lg p-6 border-2 border-gray-300 bg-white transition-all duration-300">
          <h3 class="text-lg font-semibold mb-3 text-gray-900">Real-time Feedback</h3>
          <p id="feedback" class="text-sm leading-relaxed text-gray-600">No session active. Select a pose and click Start Session.</p>
        </div>

        <!-- Target Pose Info -->
        <div id="targetPoseCard" class="bg-gradient-to-br from-green-50 to-blue-50 rounded-lg shadow-lg p-6 hidden">
          <h3 class="text-lg font-semibold text-gray-900 mb-3">Target Pose</h3>
          <div class="text-center">
            <div id="targetPoseName" class="text-xl font-bold text-green-700 mb-2">Tree Pose</div>
            <div class="text-sm text-gray-600">Hold this pose for best results</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
// Configuration
const API_BASE_URL = '/api/yoga';
const DETECTION_INTERVAL = 500; // milliseconds between detections

// State
let sessionActive = false;
let sessionTime = 0;
let timerInterval = null;
let detectionInterval = null;
let sessionId = null;
let targetPose = null;
let currentCameraFacing = 'user';
let totalFrames = 0;
let correctFrames = 0;
let isVideoMode = false;  // NEW: Track if in video upload mode
let uploadedVideo = null;  // NEW: Store uploaded video element

// DOM Elements
const videoEl = document.getElementById("webcam");
const canvasEl = document.getElementById("canvas");
const ctx = canvasEl.getContext('2d');
const toggleBtn = document.getElementById("toggleSession");
const overlay = document.getElementById("overlay");
const liveBadge = document.getElementById("liveBadge");
const timerEl = document.getElementById("sessionTimer");
const currentPoseEl = document.getElementById("currentPose");
const confidenceEl = document.getElementById("confidence");
const confidenceBarEl = document.getElementById("confidenceBar");
const feedbackEl = document.getElementById("feedback");
const feedbackCard = document.getElementById("feedbackCard");
const statusIcon = document.getElementById("statusIcon");
const statusText = document.getElementById("statusText");
const accuracyIndicator = document.getElementById("accuracyIndicator");
const targetPoseCard = document.getElementById("targetPoseCard");
const targetPoseName = document.getElementById("targetPoseName");
const switchCameraBtn = document.getElementById("switchCamera");
const totalFramesEl = document.getElementById("totalFrames");
const correctFramesEl = document.getElementById("correctFrames");
const sessionAccuracyEl = document.getElementById("sessionAccuracy");
const videoUploadInput = document.getElementById("videoUpload");  // NEW
const uploadBtn = document.getElementById("uploadBtn");  // NEW
const removeVideoBtn = document.getElementById("removeVideoBtn");  // NEW

// Get CSRF token for Django
function getCsrfToken() {
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) return csrfInput.value;
    
    const cookies = document.cookie.split('; ');
    for (let cookie of cookies) {
        if (cookie.startsWith('csrftoken=')) {
            return cookie.split('=')[1];
        }
    }
    return '';
}

// Format time display
function formatTime(seconds) {
  const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
  const secs = String(seconds % 60).padStart(2, '0');
  return `${mins}:${secs}`;
}

// Start webcam
async function startWebcam() {
  try {
    const constraints = {
        video: {
            facingMode: currentCameraFacing,
            width: { ideal: 640 },
            height: { ideal: 480 }
        }
    };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    videoEl.srcObject = stream;
    
    // Setup canvas size when video loads
    return new Promise((resolve, reject) => {
        videoEl.addEventListener('loadedmetadata', () => {
            canvasEl.width = videoEl.videoWidth || 640;
            canvasEl.height = videoEl.videoHeight || 480;
            resolve(true);
        }, { once: true });
        
        videoEl.addEventListener('error', (err) => {
            reject(err);
        }, { once: true });
    });
    
  } catch (err) {
    console.error("Webcam access denied or not available:", err);
    showFeedback("Unable to access camera. Please grant permission.", "error");
    return false;
  }
}

// Stop webcam
function stopWebcam() {
    const stream = videoEl.srcObject;
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    videoEl.srcObject = null;
}

// Switch camera (front/back)
switchCameraBtn.addEventListener("click", async () => {
    if (!sessionActive) return;
    
    currentCameraFacing = currentCameraFacing === 'user' ? 'environment' : 'user';
    stopWebcam();
    await startWebcam();
});

// Start backend session
async function startBackendSession() {
    // Default pose - you can change this or make it dynamic later
    const defaultPose = 'tree';
    
    try {
        const response = await fetch(`${API_BASE_URL}/session/start/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ pose: defaultPose })
        });
        
        const data = await response.json();
        if (data.success) {
            sessionId = data.session_id;
            targetPose = data.target_pose;
            showFeedback(`Session started! Detecting your yoga poses...`, "info");
            return true;
        } else {
            showFeedback("Failed to start session.", "error");
            return false;
        }
    } catch (error) {
        console.error('Error starting backend session:', error);
        showFeedback("Error connecting to server.", "error");
        return false;
    }
}

// End backend session
async function endBackendSession() {
    if (!sessionId) return;
    
    try {
        const response = await fetch(`${API_BASE_URL}/session/end/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ session_id: sessionId })
        });
        
        const data = await response.json();
        if (data.success) {
            showSessionSummary(data);
        }
    } catch (error) {
        console.error('Error ending session:', error);
    }
}

// Detect pose from current frame
async function detectPose() {
    if (!sessionActive || !videoEl.srcObject) return;
    
    try {
        // Check if video is ready
        if (videoEl.readyState < 2) {
            console.log('Video not ready yet');
            return;
        }
        
        // Draw current frame to canvas
        ctx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
        
        // Convert to base64
        const frameData = canvasEl.toDataURL('image/jpeg', 0.7);
        
        // Send to backend
        const response = await fetch(`${API_BASE_URL}/detect/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                frame: frameData,
                target_pose: targetPose,
                session_id: sessionId
            })
        });
        
        const result = await response.json();
        handleDetectionResult(result);
        
    } catch (error) {
        console.error('Detection error:', error);
        // Show error but don't stop the session
        handleDetectionResult({
            success: false,
            message: "Detection error occurred"
        });
    }
}

// Handle detection result
function handleDetectionResult(result) {
    // Default to incorrect if model not loaded or detection failed
    if (!result.success) {
        currentPoseEl.textContent = "No pose detected";
        confidenceEl.textContent = "0";
        confidenceBarEl.style.width = "0%";
        confidenceBarEl.className = "h-2 rounded-full bg-red-500 transition-all duration-500";
        
        statusIcon.className = "w-3 h-3 rounded-full bg-red-500";
        statusText.textContent = "Incorrect âœ—";
        statusText.className = "text-sm font-medium text-red-700";
        
        showFeedback(result.message || "No pose detected - Position yourself correctly", "error");
        
        // Still count the frame
        totalFrames++;
        updateSessionStats();
        return;
    }
    
    // Update pose display
    const poseName = result.pose.charAt(0).toUpperCase() + result.pose.slice(1).replace(/_/g, ' ');
    currentPoseEl.textContent = poseName;
    
    // Update confidence
    const confidence = (result.confidence * 100).toFixed(1);
    confidenceEl.textContent = confidence;
    confidenceBarEl.style.width = confidence + "%";
    
    // Update confidence bar color
    if (confidence >= 70) {
        confidenceBarEl.className = "h-2 rounded-full bg-green-500 transition-all duration-500";
    } else if (confidence >= 50) {
        confidenceBarEl.className = "h-2 rounded-full bg-yellow-500 transition-all duration-500";
    } else {
        confidenceBarEl.className = "h-2 rounded-full bg-red-500 transition-all duration-500";
    }
    
    // Determine if pose is correct
    // Only correct if: model loaded, confidence high, AND matches target
    const isCorrect = result.is_correct && result.matches_target;
    
    // Update status indicator - Default to incorrect
    if (isCorrect) {
        statusIcon.className = "w-3 h-3 rounded-full bg-green-500 animate-pulse";
        statusText.textContent = "Correct âœ“";
        statusText.className = "text-sm font-medium text-green-700";
        correctFrames++;
    } else {
        // Always show incorrect if not perfect match
        statusIcon.className = "w-3 h-3 rounded-full bg-red-500";
        statusText.textContent = "Incorrect âœ—";
        statusText.className = "text-sm font-medium text-red-700";
    }
    
    // Update feedback
    let feedbackText = "";
    let feedbackType = "error"; // Default to error
    
    if (isCorrect) {
        feedbackText = `âœ“ Perfect! You're holding the ${poseName} pose correctly! (${confidence}%)`;
        feedbackType = "success";
    } else if (result.matches_target === false) {
        feedbackText = `âœ— Wrong pose detected: ${poseName}. Target is ${targetPose.charAt(0).toUpperCase() + targetPose.slice(1)}`;
        feedbackType = "error";
    } else if (confidence < 70) {
        feedbackText = `âœ— Low confidence (${confidence}%). Adjust your position for better detection`;
        feedbackType = "error";
    } else {
        feedbackText = `âœ— Detected ${poseName} but not matching target ${targetPose}`;
        feedbackType = "error";
    }
    
    totalFrames++;
    showFeedback(feedbackText, feedbackType);
    updateSessionStats();
    
    // Show mode indicator if in demo mode
    if (result.mode === 'demo') {
        showFeedback(feedbackText + " [DEMO MODE - Add trained model for accurate detection]", feedbackType);
    }
}

// Update session statistics
function updateSessionStats() {
    totalFramesEl.textContent = totalFrames;
    correctFramesEl.textContent = correctFrames;
    const accuracy = totalFrames > 0 ? ((correctFrames / totalFrames) * 100).toFixed(1) : 0;
    sessionAccuracyEl.textContent = accuracy + "%";
}

// Show feedback with styling
function showFeedback(message, type) {
    feedbackEl.textContent = message;
    
    // Reset classes
    feedbackCard.className = "rounded-lg shadow-lg p-6 border-2 transition-all duration-300";
    
    // Add type-specific classes
    switch(type) {
        case "success":
            feedbackCard.classList.add("bg-green-50", "border-green-500");
            break;
        case "error":
            feedbackCard.classList.add("bg-red-50", "border-red-500");
            break;
        case "warning":
            feedbackCard.classList.add("bg-yellow-50", "border-yellow-500");
            break;
        case "info":
        default:
            feedbackCard.classList.add("bg-blue-50", "border-blue-500");
    }
}

// Show session summary
function showSessionSummary(data) {
    const minutes = Math.floor(data.duration_seconds / 60);
    const seconds = Math.floor(data.duration_seconds % 60);
    
    const summary = `Session Complete! ðŸŽ‰

Pose: ${data.pose.charAt(0).toUpperCase() + data.pose.slice(1)}
Duration: ${minutes}m ${seconds}s
Frames: ${data.correct_frames}/${data.total_frames} correct
Accuracy: ${data.accuracy.toFixed(1)}%

${data.accuracy >= 80 ? 'Excellent work! ðŸŒŸ' : data.accuracy >= 60 ? 'Good effort! Keep practicing ðŸ‘' : 'Keep practicing! You\'ll get better ðŸ’ª'}`;
    
    showFeedback(summary, data.accuracy >= 70 ? "success" : "info");
}

// Toggle session (start/stop)
toggleBtn.addEventListener("click", async () => {
    if (!sessionActive) {
        // Check if in video mode or live mode
        if (isVideoMode && uploadedVideo) {
            // Process uploaded video
            await processUploadedVideo();
        } else {
            // Start live session
            
            // Start webcam first
            const webcamStarted = await startWebcam();
            if (!webcamStarted) {
                showFeedback("Failed to start webcam", "error");
                return;
            }
            
            // Start backend session
            const sessionStarted = await startBackendSession();
            if (!sessionStarted) {
                stopWebcam();
                return;
            }
            
            // Update UI
            sessionActive = true;
            overlay.classList.add("hidden");
            liveBadge.classList.remove("hidden");
            accuracyIndicator.classList.remove("hidden");
            targetPoseCard.classList.remove("hidden");
            targetPoseName.textContent = targetPose ? targetPose.charAt(0).toUpperCase() + targetPose.slice(1).replace(/_/g, ' ') : 'Detecting...';
            
            toggleBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                </svg>
                Stop Session
            `;
            toggleBtn.classList.remove("bg-green-500", "hover:bg-green-600");
            toggleBtn.classList.add("bg-red-500", "hover:bg-red-600");
            
            // Reset counters
            sessionTime = 0;
            totalFrames = 0;
            correctFrames = 0;
            updateSessionStats();
            
            // Start timer
            timerInterval = setInterval(() => {
                sessionTime++;
                timerEl.textContent = formatTime(sessionTime);
            }, 1000);
            
            // Start detection loop after short delay to let camera initialize
            setTimeout(() => {
                if (sessionActive) {
                    detectionInterval = setInterval(detectPose, DETECTION_INTERVAL);
                }
            }, 1000);
        }
        
    } else {
        // Stop session
        if (isVideoMode) {
            await stopVideoAnalysis();
        } else {
            sessionActive = false;
            
            // Stop detection
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            
            // Stop timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // End backend session
            await endBackendSession();
            
            // Stop webcam
            stopWebcam();
            
            // Update UI
            overlay.classList.remove("hidden");
            liveBadge.classList.add("hidden");
            accuracyIndicator.classList.add("hidden");
            targetPoseCard.classList.add("hidden");
            
            toggleBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Start Session
            `;
            toggleBtn.classList.add("bg-green-500", "hover:bg-green-600");
            toggleBtn.classList.remove("bg-red-500", "hover:bg-red-600");
            
            // Reset displays
            timerEl.textContent = "00:00";
            currentPoseEl.textContent = "â€”";
            confidenceEl.textContent = "0";
            confidenceBarEl.style.width = "0%";
            
            // Reset session variables
            sessionId = null;
            targetPose = null;
        }
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    showFeedback("Click Start Session to begin your yoga practice.", "info");
});

// Video Upload Handler
videoUploadInput.addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    // Check if file is a video
    if (!file.type.startsWith('video/')) {
        showFeedback("Please upload a valid video file.", "error");
        return;
    }
    
    // Check file size (max 100MB)
    if (file.size > 100 * 1024 * 1024) {
        showFeedback("Video file is too large. Maximum size is 100MB.", "error");
        return;
    }
    
    showFeedback("Loading video...", "info");
    
    try {
        // Stop any active webcam session
        if (videoEl.srcObject) {
            stopWebcam();
        }
        
        // Create object URL for the video file
        const videoURL = URL.createObjectURL(file);
        
        // Set video source directly to the video element
        videoEl.src = videoURL;
        videoEl.srcObject = null;
        videoEl.load();
        
        // Wait for video metadata to load
        await new Promise((resolve, reject) => {
            videoEl.onloadedmetadata = () => {
                console.log('Video loaded:', videoEl.videoWidth, 'x', videoEl.videoHeight);
                
                // Set canvas size to match video
                canvasEl.width = videoEl.videoWidth || 640;
                canvasEl.height = videoEl.videoHeight || 480;
                
                resolve();
            };
            
            videoEl.onerror = (e) => {
                console.error('Video load error:', e);
                reject(new Error('Failed to load video'));
            };
            
            // Timeout after 10 seconds
            setTimeout(() => reject(new Error('Video load timeout')), 10000);
        });
        
        // Store reference
        uploadedVideo = videoEl;
        isVideoMode = true;
        
        // Hide overlay and show video
        overlay.classList.add("hidden");
        
        // Pause video initially
        videoEl.pause();
        videoEl.currentTime = 0;
        
        showFeedback(`Video loaded successfully: ${file.name}. Click "Analyze Video" to start.`, "success");
        
        // Show remove button, hide upload button
        uploadBtn.classList.add("hidden");
        removeVideoBtn.classList.remove("hidden");
        removeVideoBtn.classList.add("flex");
        
        // Update button text
        toggleBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Analyze Video
        `;
        toggleBtn.classList.remove("bg-red-500", "hover:bg-red-600");
        toggleBtn.classList.add("bg-green-500", "hover:bg-green-600");
        
        // Reset the file input so the same file can be selected again
        videoUploadInput.value = '';
        
    } catch (error) {
        console.error('Error loading video:', error);
        showFeedback(`Failed to load video: ${error.message}. Please try another file.`, "error");
        isVideoMode = false;
        uploadedVideo = null;
        videoEl.src = '';
        overlay.classList.remove("hidden");
    }
});

// Process uploaded video
async function processUploadedVideo() {
    if (!uploadedVideo || !videoEl.src) {
        showFeedback("No video loaded.", "error");
        return;
    }
    
    // Start backend session
    const sessionStarted = await startBackendSession();
    if (!sessionStarted) return;
    
    // Update UI
    sessionActive = true;
    liveBadge.classList.remove("hidden");
    liveBadge.textContent = "ANALYZING";
    accuracyIndicator.classList.remove("hidden");
    targetPoseCard.classList.remove("hidden");
    targetPoseName.textContent = targetPose ? targetPose.charAt(0).toUpperCase() + targetPose.slice(1).replace(/_/g, ' ') : 'Detecting...';
    
    toggleBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
        </svg>
        Stop Analysis
    `;
    toggleBtn.classList.remove("bg-green-500", "hover:bg-green-600");
    toggleBtn.classList.add("bg-red-500", "hover:bg-red-600");
    
    // Reset counters
    sessionTime = 0;
    totalFrames = 0;
    correctFrames = 0;
    updateSessionStats();
    
    // Reset video to start
    videoEl.currentTime = 0;
    
    // Start video playback
    try {
        await videoEl.play();
    } catch (err) {
        console.error('Error playing video:', err);
        showFeedback("Error playing video. Please try again.", "error");
        await stopVideoAnalysis();
        return;
    }
    
    // Start timer
    timerInterval = setInterval(() => {
        sessionTime++;
        timerEl.textContent = formatTime(sessionTime);
    }, 1000);
    
    showFeedback("Analyzing video... Watch the real-time feedback.", "info");
    
    // Process video frames
    await analyzeVideoFrames();
}

// Analyze video frames
async function analyzeVideoFrames() {
    const frameRate = 2; // Process 2 frames per second
    const interval = 1000 / frameRate;
    
    const processFrame = async () => {
        if (!sessionActive || videoEl.ended) {
            // Video finished, stop session
            if (sessionActive) {
                await stopVideoAnalysis();
            }
            return;
        }
        
        // Detect pose from current frame
        await detectPose();
        
        // Continue processing if session is still active
        if (sessionActive && !videoEl.ended) {
            setTimeout(processFrame, interval);
        }
    };
    
    // Start processing frames
    setTimeout(processFrame, interval);
}

// Stop video analysis
async function stopVideoAnalysis() {
    sessionActive = false;
    
    // Pause video
    if (videoEl) {
        videoEl.pause();
    }
    
    // Stop timer
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    
    // End backend session
    await endBackendSession();
    
    // Update UI
    liveBadge.classList.add("hidden");
    liveBadge.textContent = "LIVE";
    accuracyIndicator.classList.add("hidden");
    targetPoseCard.classList.add("hidden");
    
    toggleBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Analyze Video
    `;
    toggleBtn.classList.add("bg-green-500", "hover:bg-green-600");
    toggleBtn.classList.remove("bg-red-500", "hover:bg-red-600");
    
    // Reset session variables
    sessionId = null;
    targetPose = null;
    
    showFeedback("Video analysis complete! Upload another video or start a live session.", "success");
}

// Clear video mode
function clearVideoMode() {
    if (videoEl.src && !videoEl.srcObject) {
        URL.revokeObjectURL(videoEl.src);
        videoEl.src = '';
    }
    isVideoMode = false;
    uploadedVideo = null;
    overlay.classList.remove("hidden");
    
    // Show upload button, hide remove button
    uploadBtn.classList.remove("hidden");
    removeVideoBtn.classList.add("hidden");
    removeVideoBtn.classList.remove("flex");
    
    toggleBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Start Session
    `;
    toggleBtn.classList.add("bg-green-500", "hover:bg-green-600");
    toggleBtn.classList.remove("bg-red-500", "hover:bg-red-600");
    
    // Reset displays
    timerEl.textContent = "00:00";
    currentPoseEl.textContent = "â€”";
    confidenceEl.textContent = "0";
    confidenceBarEl.style.width = "0%";
    
    showFeedback("Video removed. Click Start Session to begin a live session.", "info");
}

// Remove Video Button Handler
removeVideoBtn.addEventListener('click', async () => {
    // If session is active, stop it first
    if (sessionActive) {
        await stopVideoAnalysis();
    }
    
    // Clear video mode
    clearVideoMode();
});
</script>
{% endblock %}
